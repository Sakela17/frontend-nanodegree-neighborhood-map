"use strict";var fourSquareData={client_id:"EVSGF4DMPKFDQUNTWREGWPAP1TEL1YNLTC2YAUK13BJHCQNY",client_key:"TH55VNBSYPX3ZZOPAERLTEBLTQBDWUPUCISGTBRJH3JM3ZZG",poiCategories:[{categoryName:"eat",categoryId:"4d4b7105d754a06374d81259"},{categoryName:"shop",categoryId:"4d4b7105d754a06378d81259"},{categoryName:"stay",categoryId:"4bf58dd8d48988d1fa931735"}]},mapData={mapProp:{center:{lat:41.380923,lng:2.16769},zoom:17},map:null,infowindow:null,bounds:null},viewModel={init:function(){this.initMap(),this.sendAjaxRequests()},initMap:function(){const e=mapData;e.bounds=new google.maps.LatLngBounds,e.map=new google.maps.Map(document.getElementById("map"),e.mapProp),e.infowindow=new google.maps.InfoWindow},sendAjaxRequests:function(){const e=this,t=fourSquareData;var o={};t.poiCategories.forEach(function(a){$.ajax({url:"https://api.foursquare.com/v2/venues/search/?ll=41.380923,2.16769&radius=50&categoryId="+a.categoryId+"&client_id="+t.client_id+"&client_secret="+t.client_key+"&v=20131124",dataType:"json",success:function(t){t.response.venues.forEach(function(t){o={name:t.name,id:t.id,lat:t.location.lat,lng:t.location.lng,address:t.location.formattedAddress[0],phone:t.contact.phone,url:"https://foursquare.com/v/"+t.id,icon:"img/"+a.categoryName+".png",photo:"",rating:""},e.getVenueDetails(o,a.categoryName)})},error:function(){e.errorMsg(a.categoryName)}})})},getVenueDetails:function(e,t){const o=fourSquareData;$.ajax({url:"https://api.foursquare.com/v2/venues/"+e.id+"?&client_id="+o.client_id+"&client_secret="+o.client_key+"&v=20131124",dataType:"jsonp",success:function(t){const o=t.response.venue;o.hasOwnProperty("rating")&&(e.rating=o.rating/2),o.hasOwnProperty("bestPhoto")&&(e.photo=o.bestPhoto.prefix+"100x100"+o.bestPhoto.suffix)},error:function(){console.log("Cannot load details for "+e.name)},complete:function(){viewModel.createMarker(e,t)}})},createMarker:function(e,t){const o=this,a=mapData,n=$("#venue-details"),s=$("#drawer"),i=new google.maps.Marker({map:a.map,position:{lat:e.lat,lng:e.lng},title:e.name,address:e.address,phone:e.phone,icon:e.icon,photo:e.photo,rating:e.rating,animation:google.maps.Animation.DROP,id:e.id,url:e.url});i.addListener("click",function(){const e=o.currentMarker();o.dropdownMenu()&&o.dropdownMenu(!1),this!==e?(a.infowindow.open(a.map,this),a.infowindow.setContent(this.title),o.animateMarker(this,e),o.currentMarker(this),s.hasClass("open")||s.addClass("open"),n.scrollTop(n.scrollTop()+($(".active-listing").offset().top-n.offset().top))):s.toggleClass("open")}),o[t+"ListingResults"].push(i),a.bounds.extend(i.position)},animateMarker:function(e,t){t.hasOwnProperty("animation")&&t.setAnimation(null),e.setAnimation(google.maps.Animation.BOUNCE)},dropdownMenu:ko.observable(!1),toggleDrawer:function(){$("#drawer").toggleClass("open")},currentMarker:ko.observable({}),eatListingResults:ko.observableArray([]),shopListingResults:ko.observableArray([]),stayListingResults:ko.observableArray([]),handleVenueClick:function(e,t){const o=mapData,a=ko.contextFor(t.target).$data,n=e.currentMarker(),s=t.target.closest(".drawer-content");$(".active-listing").removeClass("active-listing"),$(s).toggleClass("active-listing"),a!==n&&(e.animateMarker(a,n),o.infowindow.setContent(a.title),o.infowindow.open(o.map,a),o.map.setCenter(a.getPosition()),e.currentMarker(a))},categories:["Eat","Shop","Stay"],selectedValues:ko.observableArray(["Eat","Shop","Stay"]),fillOptions:ko.pureComputed(function(){return viewModel.selectedValues().map(function(e){return e}).join(", ")||"-- Select your POI --"}),filterMarkers:function(e){var t=viewModel,o=mapData,a=t.currentMarker,n=t[e.toLowerCase()+"ListingResults"]();t.selectedValues().includes(e)?(n.forEach(function(e){e.setMap(o.map)}),o.map.fitBounds(o.bounds)):(n.includes(a())&&(a({}),o.infowindow.close()),n.forEach(function(e){e.setMap(null)}))},errorMsg:function(e){const t=$("#hidden-msg");t.css("display","block"),t.append("<p>Failed to load resources for category "+e.italics()+".<br/>Please try again soon.</p>"),$("#"+e).append("<strong> - failed to load</strong>"),$("#close-span").click(function(){t.css("display","none")})},mapErrorMsg:function(){const e=$("#hidden-msg");e.css("display","block"),e.append("<p>Failed to load Google Maps.<br/>Please try again soon.</p>"),$("#close-span").click(function(){e.css("display","none")})}};viewModel.allSelected=ko.computed({read:function(){return 3===this.selectedValues().length},write:function(e){var t=this.selectedValues(),o=this.categories.slice(0),a=[];if(e){for(var n=0;n<o.length;n++){var s=o[n];-1===t.indexOf(s)&&a.push(s)}a.forEach(function(e){var t=e.toLowerCase()+"ListingResults";viewModel[t]().forEach(function(e){e.setMap(mapData.map)})}),this.selectedValues(o),mapData.map.fitBounds(mapData.bounds)}else t.forEach(function(e){var t=e.toLowerCase()+"ListingResults";viewModel[t]().forEach(function(e){e.setMap(null)})}),this.selectedValues([])},owner:viewModel}),ko.applyBindings(viewModel),$(window).resize(function(){mapData.map.fitBounds(mapData.bounds)});